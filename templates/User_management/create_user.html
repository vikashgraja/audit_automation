{% extends "Nav.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href='{% static "css/pass_change.css" %}'>

<div class="main">
    <h1>Register Auditor</h1>
    <form id="User_register_form" method="POST">
        {% csrf_token %}

        <label for="username">
            Username:
        </label>
        <input type="text" id="username" name="username" required="true">

        <label for="email">
            Email:
        </label>
        <input type="text" id="email" name="email" required="true">

        <label for="first_name">
            First Name:
        </label>
        <input type="text" id="first_name" name="first_name" required="true">

        <label for="last_name">
            Last Name:
        </label>
        <input type="text" id="last_name" name="last_name">

        <label for="password1">
            Password:
        </label>
        <input type="password" id="password1" name="password1" required="true">

        <label for="password2">
            Retype Password:
        </label>
        <input type="password" id="password2" name="password2" required="true">

        <label for="id_role">
            Role:
        </label>
        {{ form.role }}

        <label for="id_unit">
            Unit:
        </label>
        {{ form.unit }}



        <!--        {% for field in form %}-->
        <!--            {{field}}-->
        <!--        {% endfor %}-->



        <!--        <div class="checkbox-wrapper-4">-->
        <!--            <input class="inp-cbx" id="Admin" type="checkbox"/>-->
        <!--            <label class="cbx" for="Admin">-->
        <!--                <span>-->
        <!--                    <svg width="12px" height="10px">-->
        <!--                    <use xlink:href="#check-4"></use>-->
        <!--                    </svg>-->
        <!--                </span>-->
        <!--                <span>Admin</span>-->
        <!--            </label>-->
        <!--            <svg class="inline-svg">-->
        <!--                <symbol id="check-4" viewbox="0 0 12 10">-->
        <!--                    <polyline points="1.5 6 4.5 9 10.5 1"></polyline>-->
        <!--                </symbol>-->
        <!--            </svg>-->
        <!--        </div>-->

        <div class="wrap">
            <button type="submit">
                Submit
            </button>
        </div>
    </form>
    {% for field in form %}
    {% for error in field.errors %}
    <p style="color: red">{{ error }}</p>
    {% endfor %}
    {% endfor %}
</div>
<script id="unit-types-data" type="application/json">
        {{ unit_types_json|safe }}
    </script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const roleSelect = document.getElementById('id_role');
        const unitSelect = document.getElementById('id_unit');
        const unitTypes = JSON.parse(document.getElementById('unit-types-data').textContent);

        // Store all original options
        const allOptions = Array.from(unitSelect.options);

        function filterUnits() {
            const role = roleSelect.value;
            const currentUnitVal = unitSelect.value;

            // Clear current options
            unitSelect.innerHTML = '';

            // Always add the empty placeholder if it exists (usually value="" or "---------")
            const limit = allOptions.length;

            allOptions.forEach(function (option) {
                const unitId = option.value;

                // Keep the placeholder
                if (!unitId) {
                    unitSelect.appendChild(option);
                    return;
                }

                const unitType = unitTypes[unitId];
                let shouldShow = true;

                /* 
                   Logic:
                   - Auditor or HoS -> SUB_DOMAIN
                   - HoD -> DOMAIN
                   - Vertical Head -> VERTICAL
                   - Site Admin -> All (or default behavior)
                */

                if (role === 'Auditor' || role === 'HoS') {
                    if (unitType !== 'SUB_DOMAIN') shouldShow = false;
                } else if (role === 'HoD') {
                    if (unitType !== 'DOMAIN') shouldShow = false;
                } else if (role === 'Vertical Head') {
                    if (unitType !== 'VERTICAL') shouldShow = false;
                }
                // Site Admin sees all

                if (shouldShow) {
                    unitSelect.appendChild(option);
                }
            });

            // Try to preserve selection if valid, otherwise select first available
            if (Array.from(unitSelect.options).some(opt => opt.value === currentUnitVal)) {
                unitSelect.value = currentUnitVal;
            } else {
                unitSelect.selectedIndex = 0;
            }
        }

        roleSelect.addEventListener('change', filterUnits);

        // Initial run
        filterUnits();
    });
</script>
{% endblock content %}