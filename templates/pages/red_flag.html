{% extends "Nav.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<!-- Load Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    .page-header-new {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        margin-bottom: 24px;
        gap: 20px;
    }

    .header-actions-new {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .title-area {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .title1-clean {
        font-size: 26px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0;
        padding: 0;
    }

    .subtitle-clean {
        color: var(--text-secondary);
        font-size: 14px;
        margin: 2px 0 0 0;
    }
</style>

<div class="page-header-new">
    <div class="title-area">
        <h1 class="title1-clean">Red Flag / Exceptions</h1>
        <p class="subtitle-clean">Monitor and manage system alerts and exceptions</p>
    </div>
    <div class="header-actions-new">
        <div class="search-container">
            <i data-lucide="search"></i>
            <input type="text" id="flagSearch" class="search-input"
                placeholder="Search by name, category, or in-charge...">
        </div>
        {% if request.user.is_superuser %}
        <a class='button' href="{% url 'add_redflag' %}" style="margin: 0;">
            <i data-lucide="plus-circle" size="18"></i>
            Add Red Flag
        </a>
        {% endif %}
    </div>
</div>

<div class="table-wrapper">
    <table id="flagsTable">
        <thead>
            <tr>
                <th style="width:2%">S.No</th>
                <th style="width:12%">Category</th>
                <th style="width:25%">Name</th>
                <th>In-Charge</th>
                <th style="width:10%">Created</th>
                <th style="width:17%">Last Run</th>
                <th style="width:13%">Actions</th>
            </tr>
        </thead>
        <tbody id="flagsBody">
            {% for rf in flags %}
            <tr class="flag-row">
                <td data-label="S.No">{{ forloop.counter }}</td>
                <td data-label="Category">
                    {% if rf.category == "Red Flag" %}
                    <span class="badge badge-redflag">
                        <i data-lucide="alert-circle" size="14"></i>
                        {{ rf.category }}
                    </span>
                    {% else %}
                    <span class="badge badge-exception">
                        <i data-lucide="file-warning" size="14"></i>
                        {{ rf.category }}
                    </span>
                    {% endif %}
                </td>
                <td data-label="Name" class="flag-name"><strong>{{ rf.name }}</strong></td>
                <td data-label="InCharge">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="user" size="14" style="color: var(--secondary-color)"></i>
                        {{ rf.assigned_to }}
                    </span>
                </td>
                <td data-label="Created">{{ rf.created_at|date:"d-m-Y" }}</td>
                <td data-label="Lastrun">
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        {% if rf.lastrun %}
                        <span>{{ rf.lastrun|date:"d/m/Y" }}</span>
                        <small style="color: var(--text-secondary);">{{ rf.lastrun|time:"H:i:s" }}</small>
                        {% else %}
                        <span style="color: var(--text-secondary); font-style: italic;">Never</span>
                        {% endif %}
                    </div>
                </td>
                <td data-label="Action" class='select'>
                    <div class="action-buttons">
                        <a class='button button-outline button-compact' href="{% url 'redflag_info' flag_id=rf.id %}"
                            title="Info">
                            <i data-lucide="info" size="14"></i>
                        </a>
                        <a class='button button-outline button-compact' href="{% url 'redflag_report' flag_id=rf.id %}"
                            title="Report">
                            <i data-lucide="file-text" size="14"></i>
                        </a>
                        {% if rf.manual %}
                        <a class='button button-outline button-compact' href="{% url 'download_manual' flag=rf.id %}"
                            title="Download Manual">
                            <i data-lucide="download" size="14"></i>
                        </a>
                        {% endif %}
                        {% if request.user.is_superuser %}
                        <a class='button button-compact' href="{% url 'edit_rf' flag=rf.id %}" title="Edit">
                            <i data-lucide="edit-3" size="14"></i>
                        </a>
                        <a class='button button-danger button-compact' href="{% url 'delete_rf' flag=rf.id %}"
                            onclick="return confirm('Are You Sure to delete {{ rf.name }}')" title="Delete">
                            <i data-lucide="trash-2" size="14"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <i data-lucide="search-x"></i>
                        <p>No red flags or exceptions found.</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    lucide.createIcons();

    document.getElementById('flagSearch').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.flag-row');
        let foundAny = false;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
                foundAny = true;
            } else {
                row.style.display = 'none';
            }
        });

        const tbody = document.getElementById('flagsBody');
        const existingNoResults = document.getElementById('noResultsRow');

        if (!foundAny && rows.length > 0) {
            if (!existingNoResults) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noResultsRow';
                noResultsRow.innerHTML = `
                    <td colspan="7">
                        <div class="empty-state">
                            <i data-lucide="search-x"></i>
                            <p>No results matching "${this.value}"</p>
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
                lucide.createIcons();
            }
        } else if (existingNoResults) {
            existingNoResults.remove();
        }
    });
</script>

{% endblock content %}