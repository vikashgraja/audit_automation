{% extends "Nav.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<!-- Load Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<div class="page-header">
    <div class="header-title">
        <h1 class="title1">Red Flag / Exceptions</h1>
        <p class="subtitle" style="color: var(--text-secondary); margin-top: -16px; margin-bottom: 8px;">Monitor and
            manage system alerts and exceptions</p>
    </div>
    <div class="header-actions">
        <div class="search-container">
            <i data-lucide="search"></i>
            <input type="text" id="flagSearch" class="search-input"
                placeholder="Search by name, category, or in-charge...">
        </div>
        {% if request.user.is_superuser %}
        <a class='button' href="{% url 'add_redflag' %}">
            <i data-lucide="plus-circle" size="18"></i>
            Add Red Flag
        </a>
        {% endif %}
    </div>
</div>

<div class="table-wrapper">
    <table id="flagsTable">
        <thead>
            <tr>
                <th style="width:2%">S.No</th>
                <th style="width:12%">Category</th>
                <th style="width:25%">Name</th>
                <th>In-Charge</th>
                <th style="width:10%">Created</th>
                <th style="width:17%">Last Run</th>
                <th style="width:13%">Actions</th>
            </tr>
        </thead>
        <tbody id="flagsBody">
            {% for flag in flags %}
            <tr class="flag-row">
                <td data-label="S.No">{{ forloop.counter }}</td>
                <td data-label="Category">
                    {% if flag.category == "Red Flag" %}
                    <span class="badge badge-redflag">
                        <i data-lucide="alert-circle" size="14"></i>
                        {{ flag.category }}
                    </span>
                    {% else %}
                    <span class="badge badge-exception">
                        <i data-lucide="file-warning" size="14"></i>
                        {{ flag.category }}
                    </span>
                    {% endif %}
                </td>
                <td data-label="Name" class="flag-name"><strong>{{ flag.name }}</strong></td>
                <td data-label="InCharge">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="user" size="14" style="color: var(--secondary-color)"></i>
                        {{ flag.assigned_to }}
                    </span>
                </td>
                <td data-label="Created">{{ flag.created_at|date:"d-m-Y" }}</td>
                <td data-label="Lastrun">
                    <span style="display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="clock" size="14" style="color: var(--text-secondary)"></i>
                        {{ flag.lastrun|date:"d/m/Y" }}
                    </span>
                    <small style="color: var(--text-secondary); margin-left: 18px;">{{ flag.lastrun|time:"H:i:s"
                        }}</small>
                </td>
                <td data-label="Action" class='select'>
                    {% if flag.manual %}
                    <a class='button button-outline' href="{% url 'download_manual' flag=flag.id %}"
                        title="Download Manual">
                        <i data-lucide="download" size="16"></i>
                    </a>
                    {% endif %}
                    {% if request.user.is_superuser %}
                    <a class='button' href="{% url 'edit_rf' flag=flag.id %}" title="Edit">
                        <i data-lucide="edit-3" size="16"></i>
                    </a>
                    <a class='button button-danger' href="{% url 'delete_rf' flag=flag.id %}"
                        onclick="return confirm('Are You Sure to delete {{ flag.name }}')" title="Delete">
                        <i data-lucide="trash-2" size="16"></i>
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <i data-lucide="search-x"></i>
                        <p>No red flags or exceptions found.</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Table search functionality
    document.getElementById('flagSearch').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.flag-row');
        let foundAny = false;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
                foundAny = true;
            } else {
                row.style.display = 'none';
            }
        });

        // Handle empty state for search
        const tbody = document.getElementById('flagsBody');
        const existingNoResults = document.getElementById('noResultsRow');

        if (!foundAny && rows.length > 0) {
            if (!existingNoResults) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noResultsRow';
                noResultsRow.innerHTML = `
                    <td colspan="7">
                        <div class="empty-state">
                            <i data-lucide="search-x"></i>
                            <p>No results matching "${this.value}"</p>
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
                lucide.createIcons();
            }
        } else if (existingNoResults) {
            existingNoResults.remove();
        }
    });
</script>

{% endblock content %}